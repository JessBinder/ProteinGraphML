# ProteinGraphML

The goal of this software is to predict disease-protein (a.k.a. protein-coding gene) associations from heterogeneous knowledge graphs, embedded as feature vectors by meta-path for XGBoost machine learning (ML). In this repository the ML engineering problem is abstracted from the data sources and domain knowledge. Thus, this code and approach can be adapted for other applications.

## Table of Contents  

* [Dependencies](#Dependencies)
* [Overview of Workflow](#Overview)
* [How to Run the Workflow](#Howto)
* [Visualization](#Vis)  

## <a name="Dependencies"/>Dependencies

* Python 3.5+
* Python packages: `xgboost`, `scikit-learn`, `networkx`, `pandas`, `pony`, `matplotlib`
* R 3.4+
* R packages: `data.table`, `RPostgreSQL`, `Matrix`
* PostgreSQL database `metap` (not included in repo).

## <a name="Overview"/>Overview of Workflow:

1. From a `PostgreSQL` relational db, generate a `networkX` knowledge graph (KG). Db “adapters” return `pandas` data frames, containing nodes and edges specified via the `pony` Object Relational Model (ORM) API.
1. From the KG, and a training dataset, ML feature vectors are generated. The training dataset may be specified via Mammalian Phenotype ID or custom labeled gene list.
1. From the training dataset, an `XGBoost` predictive model is trained, using cross-validation and a grid search to optimize parameters.
1. Feature importance is inferred during training with output available for analysis.
1. The optimized `XGBoost` model is run on all genes to generate predictions as scores interpretable as probabilities of association.
1. Generation of interactive visualizations (HTML/JS) of important features as an evidence graph.


>   <img height="460px" alt="Workflow diagram" src="MetapathDiagram.png">


## <a name="Static"/>Static Features:
The static features (features which don't use metapaths) are generated by `ProteinGraphML/MLTools/StaticFeatures/staticFiles.R` as CSV files `{ccle,gtex,lincs,hpa}.csv`.
The csv files must be pickled for use by RunML.py. The static features are effectively appended to the KG-based feature vectors.

## <a name="Howto"/>How to Run the Workflow:
The codes of ProteinGraphML must be executed in the following order to avoid errors:

__1. `BuildKG_OlegDb.py`:__  Run first, to generate a knowledge graph required to run ML codes.

___KG produced may be re-used for multiple ML models. Re-run only required if database updated.___

```
BuildKG_OlegDb.py
```

__2. `PickleTrainingset.py`:__	This program generates a "pickle" dictionary that
contains protein_ids for both class 'True' and 'False'. The "pickle" dictionary is needed
if you are running ML codes for a disease that does not have MP_TERM_ID. Also, if you
have gene symbols instead of protein_ids for a disease, this code fetches the corresponding
protein_id for each symbol from the database and generates the "pickle" dictionary.

Command line parameters:

* `--file` : File that contains protein_ids/symbols and labels for a given disease, with extension (.txt|.xlsx|.rds).
* `--dir` : directory where data files are found (default: DataForML).
* `--symbol_or_pid` : "symbol" or "pid" (default: symbol).

If the file is a spreadsheet, the header should have "Protein_id Label" or "Symbol Label".
If the file is a text file, the Protein_id/symbol and
Label should be comma-separated. There should not be any header in the text file. If the
file is an RDS file, the parameter 'symbol'  can be omitted. Use one of the following,
to run this program.

```
PickleTrainingset.py --file filename.xlsx
PickleTrainingset.py --file filename.txt

E.g.
PickleTrainingset.py --file diabetes_pid.txt --symbol_or_pid 'pid'
PickleTrainingset.py --file 125853.rds
PickleTrainingset.py --file diabetes.xlsx
```

__3. `RunML.py`:__  This is the machine learning code that uses XGboost model
to classify the data using 5-fold cross-validation. It also generates a list of
important features used by the classification model. Results will be recorded in `ProteinGraphML/results`. The input disease can be defined via Mammalian phenotype
ID, or a manually created file of labeled training cases (in pickled dictionary format).

Command line parameters:

* `procedure` (positional parameter):
   * `XGBCrossValPred` :  5-fold cross-validation for one iteration.
   * `XGBCrossVal` : 5-fold cross-validation for multiple iterations.
* `--disease` : Use with Mammalian Phenotype ID, e.g. MP_0000180.
* `--file` : Pickled training set file, produced by `PickleTrainingset.py`.
* `--kgfile` : Pickled KG file, produced by `BuildKG_OlegDb.py` (default: ProteinDisease_GRAPH.pkl).

E.g.
```
RunML.py XGBCrossVal --file 144700.pkl
RunML.py XGBCrossValPred --file 144700.pkl
RunML.py XGBCrossVal --disease MP_0000180
RunML.py XGBCrossValPred --disease MP_0000180
```

__4. `MakeVis.py`:__  Generates HTML/JS files for visualization, via web browser.

Command-line parameters:

* `--disease` pickled features file produced by `RunML.py`, e.g. diabetes.pkl.
* `--dir` : dir containing file (default: results/XGBFeatures/).
* `--num` : number of top important features selected.
* `--kgfile` : Pickled KG file, produced by `BuildKG_OlegDb.py` (default: ProteinDisease_GRAPH.pkl).

E.g.

```
MakeVis.py --disease MP_0000180.pkl --num 2
```

## <a name="Vis"/>Visualization:

`ProteinGraphML/Analysis/` contains code for graph visualization and for creating charts for feature visualization. Visualize has code for creating HTML graphs, and `featureLabel` has code for taking a dictionary of feature importance, and giving it human readable labels. MakeVis.py (_prototype, in progress_) generates HTML/JS graphs given feature importance.


### Notes:

* The current system is designed for mammalian phenotype data assuming a human-to-mouse map.
* <i>The graph currently makes assumptions that all nodes are unique. Proteins are integer IDs, these are the only Ints in the graph, the current protein logic counts on this being true, so make sure you do not violate this, otherwise calculations may be off!</i>
* The current database is `metap` accessed by the `OlegDB` adapter. New adapters may be defined a new Adapter class in `ProteinGraphML/DataAdapter/`.
* To begin add your DB creds to the DBcreds.yaml file, to access database.
* Code to change settings for models in `ProteinGraphML/MLTools/Models`.
* `RunML.py` will generate a set of features, which you can expose to any "Procedure". These are generic machine learning functions defined and extensible at `ProteinGraphML/MLTools/Procedures/`.
* `RunML.py` : `staticFeatures = [] becomes -> ["gtex","lincs","ccle","hpa"]`
